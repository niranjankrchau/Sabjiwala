<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your Cart</title>
  <style>
   .banner {
      background: linear-gradient(to right, #ff6a00, #ee0979);
      color: white;
      padding: 40px 20px;
      text-align: center;
      font-family: 'Arial', sans-serif;
      position: relative;
    }

    .banner h1 {
      font-size: 2.5em;
      margin: 0 0 10px;
    }

    .banner p {
      font-size: 1.2em;
      margin-bottom: 20px;
    }

    .banner .btn {
      background-color: white;
      color: #ff6a00;
      padding: 12px 25px;
      border: none;
      border-radius: 25px;
      font-size: 1em;
      text-decoration: none;
      cursor: pointer;
      transition: background 0.3s ease, color 0.3s ease;
    }

    .banner .btn:hover {
      background-color: #ffe2d1;
      color: #d94c00;
    }
    table, th, td {
      border: 1px solid black;
      border-collapse: collapse;
      padding: 8px;
    }

    #cartTable {
      width: 100%;
      margin-top: 15px;
    }

    button {
      padding: 6px 12px;
      margin: 2px;
      cursor: pointer;
    }

    .summary {
      margin-top: 20px;
    }

    .header-info {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
<div class="login-card">
  <div class="banner">
  <h1>Sabjiwala</h1>
  <p>Apni Local Dukan</p>
   </div>
  <div class="header-info">
    <h2>üõí Cart for <span id="cartUsername"></span></h2>
    <p>üìû Mobile: <strong id="cartMobile"></strong></p>
  </div>
  <button onclick="logout()">üö™ Log Out</button>

  <table id="cartTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Weight</th>
        <th>Price</th>
        <th>Quantity</th>
        <th>Total Quantity</th>
        <th>Amount</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="summary">
    <h3>
      üßæ Summary: 
      <br>üß∫ Items in Cart: <span id="itemCount">0</span>
      <br>üî¢ Total Quantity: <span id="totalQty">0</span>
      <br>üí∞ Total Price: ‚Çπ<span id="totalPrice">0.00</span>
    </h3>
  </div>

  <div class="address-section">
    <h3>üìç Delivery Address</h3>
    <label for="address">Full Address:</label><br />
    <textarea id="address" rows="3" cols="50" placeholder="Enter full address" required></textarea><br /><br />

    <label for="landmark">Landmark:</label><br />
    <input type="text" id="landmark" placeholder="Near park / school / shop..." /><br /><br />

    <label for="pincode">Pincode:</label><br />
    <input type="text" id="pincode" placeholder="6-digit pincode" maxlength="6" inputmode="numeric" /><br /><br />
  </div>

  <button onclick="goBack()">üîô Back to Shop</button>
  <button onclick="clearCart()">üóë Clear Cart</button>

  <label for="paymentMode">üí≥ Payment Mode:</label><br />
  <select id="paymentMode" required>
    <option value="">-- Select Payment Mode --</option>
    <option value="Debit Card">Debit Card</option>
    <option value="Credit Card">Credit Card</option>
    <option value="UPI">UPI</option>
    <option value="Netbanking">Netbanking</option>
    <option value="Cash">Cash</option>
  </select><br /><br />

  <button onclick="checkout()">‚úÖ Checkout</button>

  <script>
    const username = localStorage.getItem('username');
    const mobile = localStorage.getItem('mobile');

    if (!username || !mobile) {
      alert('Please login first.');
      window.location.href = 'indexnew.html';
    }

    document.getElementById('cartUsername').textContent = username;
    document.getElementById('cartMobile').textContent = mobile;

    function getCart() {
      return JSON.parse(localStorage.getItem(`cart_${mobile}`) || '[]');
    }

    function saveCart(cart) {
      localStorage.setItem(`cart_${mobile}`, JSON.stringify(cart));
    }

    function renderCart() {
      let cart = getCart();
      const tbody = document.querySelector('#cartTable tbody');
      tbody.innerHTML = '';

      let total = 0;
      let totalQty = 0;

      if (cart.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8">Your cart is empty.</td></tr>';
        document.getElementById('totalPrice').innerText = '0.00';
        document.getElementById('itemCount').innerText = '0';
        document.getElementById('totalQty').innerText = '0';
        return;
      }

      cart.forEach((item, index) => {
        const itemTotal = item.price * item.qty;
        total += itemTotal;
        totalQty += item.qty;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.name}</td>
          <td>${item.weight} ${item.unit}</td>
          <td>‚Çπ${item.price}</td>
          <td>
            <button onclick="updateQty(${index}, -1)" ${item.qty === 1 ? 'disabled' : ''}>‚àí</button>
            ${item.qty}
            <button onclick="updateQty(${index}, 1)">+</button>
          </td>
          <td>${item.qty}</td>
          <td>‚Çπ${itemTotal.toFixed(2)}</td>
          <td><button onclick="deleteItem(${index})">Delete</button></td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById('totalPrice').innerText = total.toFixed(2);
      document.getElementById('itemCount').innerText = cart.length;
      document.getElementById('totalQty').innerText = totalQty;
    }

    function updateQty(index, change) {
      let cart = getCart();
      cart[index].qty += change;
      if (cart[index].qty < 1) {
        cart[index].qty = 1;
      }
      saveCart(cart);
      renderCart();
    }

    function deleteItem(index) {
      let cart = getCart();
      cart.splice(index, 1);
      saveCart(cart);
      renderCart();
    }

    function clearCart() {
      if (confirm("Are you sure you want to clear the cart?")) {
        saveCart([]);
        renderCart();
      }
    }

    function checkout() {
      const cart = getCart();
      if (cart.length === 0) {
        alert("Cart is empty. Add items before checkout.");
        return;
      }

      const address = document.getElementById('address').value.trim();
      const landmark = document.getElementById('landmark').value.trim();
      const pincode = document.getElementById('pincode').value.trim();
      const paymentMode = document.getElementById('paymentMode').value;

      if (!address || !landmark || !/^\d{6}$/.test(pincode)) {
        alert("Please complete address, landmark, and valid 6-digit pincode.");
        return;
      }

      if (!paymentMode) {
        alert("Please select a payment mode.");
        return;
      }

      if (confirm("Confirm checkout and place the order?")) {
        const totalAmount = cart.reduce((sum, item) => sum + item.qty * item.price, 0);
        const fullAddress = `${address}, Landmark: ${landmark}, Pincode: ${pincode}`;

        const order = {
          id: Date.now(),
          username,
          mobile,
          address: fullAddress,
          date: new Date().toLocaleString(),
          total: totalAmount,
          items: cart,
          paymentMode
        };

        let orderHistory = JSON.parse(localStorage.getItem(`orders_${mobile}`) || "[]");
        orderHistory.push(order);
        localStorage.setItem(`orders_${mobile}`, JSON.stringify(orderHistory));

        saveCart([]);
        renderCart();

        alert(`‚úÖ Order #${order.id} placed successfully!\nüßæ Invoice will now open.`);
        printInvoice(order);

        const paymentLinks = {
          "Debit Card": "https://examplebank.com/debit",
          "Credit Card": "https://www.sbicard.com/",
          "UPI": "https://pay.google.com/",
          "Netbanking": "https://netbanking.hdfcbank.com/netbanking/",
          "Cash": null
        };

        if (paymentLinks[paymentMode]) {
          alert(`Redirecting to ${paymentMode} payment page...`);
          window.open(paymentLinks[paymentMode], "_blank");
        } else {
          alert("üíµ You chose Cash on Delivery. No payment page needed.");
        }
      }
    }

    function printInvoice(order) {
      let html = `
        <h2>üßæ Invoice - Order #${order.id}</h2>
        <p><strong>Customer:</strong> ${order.username}</p>
        <p><strong>Mobile:</strong> ${order.mobile}</p>
        <p><strong>Address:</strong> ${order.address}</p>
        <p><strong>Date:</strong> ${order.date}</p>
        <table border="1" cellpadding="8" cellspacing="0">
          <thead><tr><th>Name</th><th>Weight</th><th>Qty</th><th>Price</th><th>Amount</th></tr></thead>
          <tbody>
      `;

      order.items.forEach(item => {
        const amount = item.price * item.qty;
        html += `
          <tr>
            <td>${item.name}</td>
            <td>${item.weight} ${item.unit}</td>
            <td>${item.qty}</td>
            <td>‚Çπ${item.price}</td>
            <td>‚Çπ${amount.toFixed(2)}</td>
          </tr>
        `;
      });

      html += `
          </tbody>
        </table>
        <h3>Total: ‚Çπ${order.total.toFixed(2)}</h3>
        <p>Payment Mode: ${order.paymentMode}</p>
        <button onclick="window.print()">üñ® Print this invoice</button>
      `;

      const win = window.open('', '', 'width=800,height=700');
      win.document.write(`<html><head><title>Invoice</title></head><body>${html}</body></html>`);
      win.document.close();
    }

    function goBack() {
      window.location.href = 'customer_vegetables.html';
    }

    function logout() {
      if (confirm("Are you sure you want to log out?")) {
        window.location.href = 'indexnew.html';
      }
    }

    window.onload = renderCart;
  </script>
</body>
</html>
